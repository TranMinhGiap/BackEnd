extends ../../layouts/default.pug
include ../../mixins/table-tree.pug
include ../../mixins/filter-status.pug
include ../../mixins/search.pug
include ../../mixins/pagination.pug
include ../../mixins/form-change-multi.pug
include ../../mixins/sort.pug

block main
  if(role.permissions.includes("products-category_view"))
    h1.text-center Danh mục sản phẩm
    
    .card.mb-3
      .card-header Bộ lọc và Tìm kiếm
      .card-body
        .row
          .col-6
            //- +filter-status(filterStatus)
          .col-6 
            +search(keyword)
    .card.mb-3
      .card-header Danh mục sản phẩm
      .card-body
        .row 
          .col-8
            if(role.permissions.includes("products-category_edit"))
              +form-change-multi(`${prefixAdmin}/products-category/change-multi?_method=PATCH`)
          .col-4
            if(role.permissions.includes("products-category_create"))
              a(
                href=`${prefixAdmin}/products-category/create`
                class="btn btn-outline-success"
              ) + Thêm mới
          .col-12 
            .card.mb-3
              .card-header Sắp xếp
              .card-body
                .row
                  .col-4
                    +sort()

        table(
          class="table table-hover table-sm"
          checkbox-multi
        )
          thead
            tr 
              th 
                input(type="checkbox" name="checkall")
              th STT
              th Hình ảnh
              th Tiêu đề
              th Vị trí
              th Trạng thái
              th Người tạo
              th Người cập nhật
              th Hành động
          tbody 
            if (resultSearch.search)
              each item in resultSearch.records
                tr 
                  th 
                    input(type="checkbox" name="id" value=item.id)
                  td #{item.index}
                  td
                    img(src=item.thumbnail alt=item.title width="90px" height="auto")
                  td #{prefix}#{item.title}
                  td
                    if(role.permissions.includes("products-category_edit"))
                      input(
                        type="number"
                        value=item.position 
                        style="width: 40px"
                        min=1
                        name="position"
                      )
                    else 
                      span(
                        class="badge badge-danger text-center"
                      ) #{item.position}
                  td
                    if(role.permissions.includes("products-category_edit"))
                      if(item.status === "active")
                        button(
                          button-change-status
                          data-status="active"
                          data-id=item.id
                          class="badge badge-success"
                        ) Hoạt động
                      else 
                        button(
                          button-change-status
                          data-status="inactive"
                          data-id=item.id
                          class="badge badge-danger"
                        ) Dừng hoạt động
                    else 
                      if(item.status === "active")
                        span(
                          class="badge badge-success"
                        ) Hoạt động
                      else 
                        span(
                          class="badge badge-danger"
                        ) Dừng hoạt động
                  td 
                    b(class="badge badge-info") #{item.userName || "Quản trị viên"}
                    div #{item.date ? item.date.toLocaleDateString("vi-VN") : "--/--/----"}
                  td 
                    if item.updatedBy.length > 0
                      - const lastUserUpdate = item.updatedBy[item.updatedBy.length - 1];
                      b(class="badge badge-primary") #{lastUserUpdate.userName.fullName}
                      div #{lastUserUpdate.updatedAt.toLocaleDateString("vi-VN")}
                    else 
                      span(class="badge badge-warning") Chưa cập nhật
                  td
                    if(role.permissions.includes("products-category_edit"))
                      a(
                        href=`${prefixAdmin}/products-category/edit/${item.id}`
                        class="btn btn-warning btn-sm"
                      ) Sửa
                    if(role.permissions.includes("products-category_delete"))
                      button(
                        class="btn btn-danger btn-sm ml-1"
                        data-id=item.id
                        button-delete
                      ) Xóa
                    a(
                      href=`${prefixAdmin}/products-category/detail/${item.id}`
                      class="btn btn-secondary btn-sm ml-1"
                    ) Chi tiết
            else
              +table-tree(records)
    //- +pagination(pagination)
          
    form(
      action=""
      method="POST"
      id="form-delete-item"
      data-path=`${prefixAdmin}/products-category/delete`
    )
    //- Form chang status
    form(
      action=""
      method="POST"
      id="form-change-status"
      data-path=`${prefixAdmin}/products-category/change-status`
    ) 
    script(src="/Admin/js/product-category.js")
    script(src="/Admin/js/product.js")
  else
    span(
      class="badge badge-danger text-center"
    ) Không có quyền truy cập! Liên hệ với admin để hỗ trợ.